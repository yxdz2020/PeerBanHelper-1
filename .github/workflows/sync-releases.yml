name: üîÑ Sync Upstream Releases & Assets (Official GH CLI)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

# ----------------------------------------------------
# ‚ö†Ô∏è!! ‰∏äÊ∏∏‰ªìÂ∫ìÂú∞ÂùÄÂ∑≤Êõ¥Êñ∞ !!
env:
  UPSTREAM_REPO: 'PBH-BTN/PeerBanHelper'
# ----------------------------------------------------

jobs:
  # --- ‰Ωú‰∏ö 1: Ê£ÄÊü•ÊúâÂì™‰∫õ Releases Áº∫Â§± ---
  check:
    runs-on: ubuntu-latest
    outputs:
      missing_tags: ${{ steps.check_tags.outputs.MISSING_TAGS }}

    steps:
      - name: 1. Ê£ÄÊü•Áº∫Â§±ÁöÑ Release Ê†áÁ≠æ (ÊåâÈ°∫Â∫è)
        id: check_tags
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWN_REPO: ${{ github.repository }}
        run: |
          echo "Fetching releases from upstream: $UPSTREAM_REPO"
          gh release list --repo $UPSTREAM_REPO --limit 300 --json tagName --jq '.[] | .tagName' > upstream_tags_raw.txt
          
          echo "Fetching releases from own repo: $OWN_REPO"
          gh release list --repo $OWN_REPO --limit 300 --json tagName --jq '.[] | .tagName' > own_tags.txt

          # ----------------------------------------------------
          # ‚ö†Ô∏è!! ËøôÂ∞±ÊòØ‰øÆÊ≠£ÁöÑÂú∞Êñπ !!
          # vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
          # 'sort -V' ÊîπÂõû 'sort'Ôºå‰ª•ÂÖºÂÆπ 'comm' ÂëΩ‰ª§
          sort upstream_tags_raw.txt > upstream_tags.txt
          # ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
          # ----------------------------------------------------

          echo "Comparing tags..."
          # ----------------------------------------------------
          # ‚ö†Ô∏è!! Ëøô‰πüÊòØ‰øÆÊ≠£ÁöÑÂú∞Êñπ !!
          # vvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvvv
          # 'sort -V' ÊîπÂõû 'sort'
          comm -23 upstream_tags.txt <(sort own_tags.txt) > missing_tags.txt
          # ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
          # ----------------------------------------------------

          if [ ! -s missing_tags.txt ]; then
            echo "‚úÖ Releases are already in sync."
            echo "MISSING_TAGS=''" >> $GITHUB_OUTPUT
          else
            echo "üîî Found missing tags (oldest to newest):"
            cat missing_tags.txt
            {
              echo 'MISSING_TAGS<<EOF'
              cat missing_tags.txt
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          fi

  # --- ‰Ωú‰∏ö 2: ÂêåÊ≠•Áº∫Â§±ÁöÑ Releases (ÊåâÈ°∫Â∫è) ---
  sync:
    needs: check
    if: needs.check.outputs.missing_tags != ''

    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: "2. Âæ™ÁéØÂêåÊ≠• Release (‰ªéÊóßÂà∞Êñ∞)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWN_REPO: ${{ github.repository }}
          TAG_LIST: ${{ needs.check.outputs.missing_tags }}
        run: |
          echo "$TAG_LIST" | while read TAG_TO_SYNC; do
            if [ -z "$TAG_TO_SYNC" ]; then continue; fi

            echo "================================================="
            echo "Syncing release for tag: $TAG_TO_SYNC"
            
            # --- Ê≠•È™§ 2.1: Ëé∑Âèñ‰∏äÊ∏∏ Release ËØ¶ÁªÜ‰ø°ÊÅØ ---
            echo "--- Fetching release metadata from $UPSTREAM_REPO ---"
            if ! gh release view $TAG_TO_SYNC --repo $UPSTREAM_REPO \
              --json name,body,isPrerelease,targetCommitish > release_details.json; then
              
                echo "‚ö†Ô∏è ERROR: Êó†Ê≥ïËé∑Âèñ $TAG_TO_SYNC ÁöÑËØ¶ÊÉÖ„ÄÇ"
                echo "ËøôÂèØËÉΩÊòØ‰∏Ä‰∏™ 'ËçâÁ®ø' (Draft) ÊàñÂ∑≤ÊçüÂùèÁöÑ Release„ÄÇÊ≠£Âú®Ë∑≥Ëøá..."
                continue
            fi

            # --- Ê≠•È™§ 2.2: ÂáÜÂ§á gh ÂëΩ‰ª§ÁöÑÂèÇÊï∞ ---
            TITLE=$(jq -r .name release_details.json)
            NOTES_FILE="notes.txt"

            # 1. ÂÖàÂÜôÂÖ• "Synced from"
            echo -e "Synced from https://github.com/$UPSTREAM_REPO\n\n" > $NOTES_FILE
            
            # 2. ÂÜçËøΩÂä†‰∏äÊ∏∏ÁöÑÂéüÂßã body
            jq -r .body release_details.json >> $NOTES_FILE

            IS_PRERELEASE=$(jq -r .isPrerelease release_details.json)
            TARGET_SHA=$(jq -r .targetCommitish release_details.json)
            
            EXTRA_ARGS=""
            if [[ "$IS_PRERELEASE" == "true" ]]; then
              EXTRA_ARGS="--prerelease"
            fi

            # --- Ê≠•È™§ 2.3: Âú®ÂΩìÂâç‰ªìÂ∫ìÂàõÂª∫ Release (‰ªÖÂÖÉÊï∞ÊçÆ) ---
            echo "--- Creating release metadata in $OWN_REPO ---"
            gh release create $TAG_TO_SYNC \
              --repo $OWN_REPO \
              --title "$TITLE" \
              --notes-file $NOTES_FILE \
              --target $TARGET_SHA \
              $EXTRA_ARGS

            echo "--- Created metadata for release: $TAG_TO_SYNC"

            # --- Ê≠•È™§ 2.4: ‰∏ãËΩΩ‰∏äÊ∏∏ Release ÁöÑÊâÄÊúâÈôÑ‰ª∂ ---
            echo "--- Downloading assets from $UPSTREAM_REPO ---"
            mkdir -p ./temp_assets
            gh release download $TAG_TO_SYNC --repo $UPSTREAM_REPO --dir ./temp_assets

            # --- Ê≠•È™§ 2.5: ‰∏ä‰º†ÈôÑ‰ª∂Âà∞Êñ∞ÂàõÂª∫ÁöÑ Release ---
            if [ -z "$(ls -A ./temp_assets)" ]; then
               echo "No assets found for this release."
            else
               echo "--- Uploading assets to $OWN_REPO ---"
               gh release upload $TAG_TO_SYNC --repo $OWN_REPO --clobber ./temp_assets/*
               echo "‚úÖ Synced release with assets: $TAG_TO_SYNC"
            fi
            
            rm -f release_details.json notes.txt
            rm -rf ./temp_assets
          done # Âæ™ÁéØÁªìÊùü

  # --- ‰Ωú‰∏ö 3Ôºö‰øÆÂ§ç "Latest" Ê†áÁ≠æ ---
  fix_latest:
    needs: sync
    if: always() 
    
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: 3. ‰øÆÊ≠£ "Latest" Ê†áÁ≠æ
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWN_REPO: ${{ github.repository }}
        run: |
          echo "Checking upstream for 'Latest' release..."
          LATEST_TAG=$(gh release list --repo $UPSTREAM_REPO --limit 1 --json tagName --jq '.[0].tagName')
          
          if [ -z "$LATEST_TAG" ]; then
            echo "Upstream has no 'Latest' release defined. Skipping."
            exit 0
          fi
          
          echo "Upstream 'Latest' tag is: $LATEST_TAG"
          
          echo "Setting '$LATEST_TAG' as 'Latest' on $OWN_REPO"
          if ! gh release view $LATEST_TAG --repo $OWN_REPO > /dev/null; then
            echo "‚ö†Ô∏è ERROR: 'Latest' tag ($LATEST_TAG) was not successfully synced to $OWN_REPO. Skipping 'latest' update."
            exit 0
          fi

          gh release edit $LATEST_TAG --repo $OWN_REPO --latest
          
          echo "‚úÖ 'Latest' tag successfully set to $LATEST_TAG."
